<!DOCTYPE html>

<head>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>画册</title>
    <script language="javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <style type="text/css">
        * {
            padding: 0;
            margin: 0;
        }

        .anm {
            transition: all 500ms ease;
            -webkit-transition: all 500ms ease;
        }

        body {
            font-family: Arial, "微软雅黑", "黑体";
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            -khtml-user-select: none;
            user-select: none;
            overflow: hidden;
        }

        html {
            background: #111 url(data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAIAAAAmkwkpAAAAGklEQVR42mMQhAEJCQkGOAtIMsBZIA6cBQQAW5wDhYzvi1MAAAAASUVORK5CYII%3D);
            color: #fff;
        }

        ul {
            list-style: none
        }

        .screen {
            overflow: hidden;
            opacity: 0;
        }

        .film {
            position: relative;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .frame {
            position: relative;
            float: left;
            text-align: center;
            height: 100%;
        }

        img {
            position: relative;
            top: 0px;
            max-width: 100%;
            height: auto;
        }

        /*图片info*/
        .info {
            position: absolute;
            text-align: center;
            background: rgba(0, 0, 0, .7);
            color: #CCC;
            z-index: 1;
            padding-left: 9px;
            padding-right: 9px;
            padding-top: 23px;
            padding-bottom: 23px;
            line-height: 30px;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="screen">
        <div class="film">
            <script type="text/javascript">
                var GALLERY_DATA = {
                    moment: {
                        "1430634537.jpg": "屈从于视觉",
                        "1430634580.jpg": "对于简单、工整、有创意的小设计毫无免疫力",
                        "1430634606.jpg": "每一处改进我都精力充沛欣喜若狂 2015/5/3",
                        "1430637216.jpg": "快快长大",
                    },
                    theater: {
                        "1430636526.jpg": "我们行走在爱的小路上，终会再次相逢",
                        "1430636589.jpg": "酒馆刺杀的这段戏我已经看了好多好多遍——《教父2》",
                        "1430636630.jpg": "望之生畏——《沉默的羔羊2汉尼拔》",
                        "1430636691.jpg": "盖茨比",
                        "1430636728.jpg": "你又正经又淫荡还那么认真——《失乐园》",
                        "1430636772.jpg": "是这个社会在改变着我们——《辩护人》",
                        "1430636840.jpg": "人们总是倾向于同情弱者，以此来凸显自己的道德存在感——《狩猎》",
                        "1430636918.jpg": "干干净净，简简单单，那个人最终都从我们的世界消失了——《横道世之介》",
                        "1430636944.jpg": "所以请不要再哭了，就像那天早晨她溜走时脸上带着的微笑好不好——《向阳处的她》",
                        "1430636953.jpg": "浩介君，每一次相遇都是久别后的重逢",
                    },
                    works: {
                        "1430632890.jpg": "我的书桌我的书",
                        "1430632897.jpg": "暴雨之后",
                        "1430632924.jpg": "the sun-burnt hand",
                        "1430632934.jpg": "",
                        "1430632951.JPG": "",
                        "1430632962.JPG": "蒲公英",
                        "1430632977.jpg": "",
                        "1430632989.jpg": "小猪猪",
                        "1430633017.jpg": "五年",
                        "1430633032.jpg": "两个人 一封信",
                        "1430633073.JPG": "学校门口的小店",
                        "1430633085.JPG": "果实",
                        "1430633096.jpg": "人民大会堂",
                        "1430633117.jpg": "巷子",
                        "1430633128.jpg": "天坛",
                        "1430633139.jpg": "the starry night",
                        "1430633151.jpg": "夏天",
                        "1430633177.jpg": "长安南路",
                        "1430633189.jpg": "春和景明",
                        "1430633199.jpg": "郁金香",
                        "1430633207.jpg": "樱花",
                        "1430633213.jpg": "",
                        "1430633224.jpg": "灵感",
                        "1430633248.jpg": "我的黑人兄弟",
                        "1430633263.jpg": "午夜场开始啦",
                        "1430633273.JPG": "校园里的夏天",
                    }
                }
                var path = window.location.search.indexOf('moment') > 0 && 'moment' || window.location.search.indexOf('theater') > 0 && 'theater' || window.location.search.indexOf('works') > 0 && 'works' || 'works'
                var GALLERY = GALLERY_DATA[path];
                var htmlStr = '';

                for (key in GALLERY) {
                    htmlStr += '<div class="frame"> <img data-src="' + path + '/' + key + '" src="" data-alt="' + GALLERY[key] + '"/> </div>'
                }
                document.write(htmlStr)
            </script>
        </div>
    </div>
    <script language="javascript">
        var supportCSS = (function () {
            var div = document.createElement('div'),
                vendors = 'Khtml Ms O Moz Webkit'.split(' '),
                len = vendors.length;
            return function (prop) {
                if (prop in div.style) return true;
                prop = prop.replace(/^[a-z]/, function (val) {
                    return val.toUpperCase();
                });
                while (len--) {
                    if (vendors[len] + prop in div.style) {
                        return true;
                    }
                }
                return false;
            };
        })();
        //
        var wid;
        var hit;
        var supportTouch;
        var supportTransform
        $(document).ready(function (e) {
            //侦听设备方向调整
            window.addEventListener("orientationchange", function () {
                window.location.reload();
            }, false);
            //
            supportTouch = 'ontouchstart' in document;
            supportTransform = supportCSS('transform');
            //
            $(".screen").animate({ opacity: 1 }, "fast");
            wid = $(window).width();
            hit = $(window).height();
            //调用父框架的页面尺寸
            if (typeof (parent.VW) != "undefined") {
                wid = parent.VW;
            };
            if (typeof (parent.VH) != "undefined") {
                hit = parent.VH;
            };
            $(".frame").width(wid);
            $(".film").width(wid * $(".frame").length);
            $(".film").height(hit);
            $(".screen").width(wid);
            $(".screen").height(hit);
            //很明显这个算法改进了很多，总之它实现的功能是预先加载N张图片，每次点击都预加载第N+1张，有效控制了流量
            //初始化预解析yoyo张图片，yoyo一定要小于图片总数
            var yoyo = 5;
            for (var i = 0; i < yoyo; i++) {
                //正向解析yoyo张
                var tmp1 = $(".frame").eq(i).find("img");
                tmp1.attr("src", tmp1.data("src"));
                presize(tmp1);
                //初始负向解析yoyo张
                var tmp2 = $(".frame").eq($(".frame").length - 1 - i).find("img");
                tmp2.attr("src", tmp2.data("src"));
                presize(tmp2);
            };
            $("html").click(function (e) {
                carrousel(e.pageX);
            });

            function carrousel(msx) {
                var left = parseInt($(".film").css("left"));
                // if(msx>=wid/2 && !$(".film").is(":animated")){
                if (msx >= wid / 2 && !$(".film").is(":animated")) {
                    //正向预解析第yoyo张
                    var tmp1 = $(".frame").eq(yoyo).find("img");
                    tmp1.attr("src", tmp1.data("src"));
                    presize(tmp1);
                    var tmp11 = $(".frame").eq(1).find("img");
                    tmp11.attr("src", tmp11.data("src"));
                    presize(tmp11);
                    //
                    if (supportTransform) {
                        setTimeout(function () {
                            $('.film').addClass('anm');
                            $('.film').css('transform', 'translate3d(' + (-wid) + 'px,0,0)');
                        }, 10);
                        setTimeout(function () {
                            $('.film').removeClass('anm');
                            //
                            var first = $('.frame').first().clone();
                            $('.film').append(first);
                            $('.frame').first().remove();
                            $('.film').css('transform', 'translate3d(' + (0) + 'px,0,0)');
                        }, 510);
                    } else {
                        $(".film").animate({ "left": (left - wid) + "px" }, "slow", function () {
                            $(".film").css("left", "0px");
                            film_first();
                        });
                    };

                    function film_first() {
                        var tmp = $(".film").find(".frame").eq(0).clone(true);
                        $(".film").find(".frame").eq(0).remove();
                        tmp.appendTo($(".film"));
                        //帧左移则将最后一张图片内容清空
                        $(".frame").eq($(".frame").length - 1).find("img").attr("src", "");
                    }
                } else if (msx < wid / 2 && !$(".film").is(":animated")) {
                    //负向预解析第yoyo张
                    var tmp2 = $(".frame").eq($(".frame").length - 1 - yoyo).find("img");
                    tmp2.attr("src", tmp2.data("src"));
                    presize(tmp2);
                    var tmp22 = $(".frame").eq($(".frame").length - 1).find("img");
                    tmp22.attr("src", tmp22.data("src"));
                    presize(tmp22);
                    //
                    var tmp = $(".film").find(".frame").eq($(".film").find(".frame").length - 1).clone(true);
                    $(".film").find(".frame").eq($(".film").find(".frame").length - 1).remove();
                    $(".film").prepend(tmp);
                    //
                    if (supportTransform) {
                        $(".film").css('transform', 'translate3d(' + (-wid) + 'px,0,0)');
                        setTimeout(function () {
                            $(".film").addClass('anm');
                            $(".film").css('transform', 'translate3d(' + (0) + 'px,0,0)');
                        }, 10);
                        setTimeout(function () {
                            $(".film").removeClass('anm');
                        }, 510);
                    } else {
                        $(".film").css("left", (-wid) + "px");
                        $(".film").animate({ "left": left + "px" }, "slow", function () {
                            $(".film").css("left", "0px");
                            //帧右移则将第2张图片清空
                            $(".frame").eq(1).find("img").attr("src", "");
                        });
                    }
                };
            };
            if (!supportTouch) {
                $("img").hover(
                    function () {
                        $(this).parent().find(".info").stop().animate({ "opacity": 1 }, "normal");
                    },
                    function () {
                        //$(this).parent().find(".info").stop().animate({"opacity":0},"normal");
                    });
            };
            //手势滑动
            (function () {
                var target = $('.film').get(0);
                var startY = 0;
                var startX = 0;
                var delta = 50;
                var fired51 = false;
                var fired52 = false;
                var fired53 = false;
                var fired54 = false;
                var lasthit;
                target.addEventListener('touchstart', function (e) {
                    startY = e.touches[0].clientY;
                    startX = e.touches[0].clientX;
                    fired51 = fired52 = fired53 = fired54 = false;
                });
                target.addEventListener('touchmove', function (e) {
                    e.stopPropagation();
                    e.preventDefault();
                    var deltaX = e.touches[0].clientX - startX;
                    var deltaY = e.touches[0].clientY - startY;
                    if (Math.abs(deltaX) >= Math.abs(deltaY)) {
                        if (deltaX > delta) {
                            fired52 = true;
                        } else {
                            fired52 = false;
                        };
                        if (deltaX < -delta) {
                            fired54 = true;
                        } else {
                            fired54 = false;
                        };
                    } else {
                        if (deltaY > delta) {
                            fired53 = true;
                        } else {
                            fired53 = false;
                        };
                        if (deltaY < -delta) {
                            fired51 = true;
                        } else {
                            fired51 = false;
                        };
                    }
                });
                target.addEventListener('touchend', function (e) {
                    if (fired51) {

                    };
                    if (fired52) {
                        carrousel(wid / 2 - 1);
                    };
                    if (fired53) {

                    };
                    if (fired54) {
                        carrousel(wid / 2 + 1);
                    };
                });
            })();
        });

        function presize(target) {
            $("<img/>").attr("src", target.attr("src")).load(function () {
                var img_w = this.width;
                var img_h = this.height;
                // if(img_h>hit){
                // 	target.css("height",hit);
                // }else{
                // 	target.css("top",(hit-img_h)/2+"px")
                // };
                target.css("top", (hit - $(target).height()) / 2 + "px");
                //图片info
                if (target.data("alt").length > 0 && target.parent().find(".info").length == 0) {
                    target.parent().prepend('<div class="info"></div>');
                    if (!supportTouch) {
                        target.parent().find(".info").css({
                            "width": parseInt(target.css("width")) - 18 + "px",
                            "left": (wid - parseInt(target.css("width"))) / 2 + "px",
                            "bottom": target.css("top"),
                            "opacity": 0
                        })
                    } else {
                        target.parent().find(".info").css({
                            "width": "100%",
                            "background": "rgba(0,0,0,.01)",
                            "left": "0",
                            "bottom": "1em",
                            "padding": "0",
                            "line-height": "1.2em",
                            "color": "#8F8F8F",
                            "opacity": "1"
                        });
                    };
                    target.parent().find(".info").html('<span>' + target.data("alt") + '</span>');
                };
            });
        };
    </script>
</body>

</html>